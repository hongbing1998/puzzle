let puzzle={row:0,col:0,steps:0,bSize:1,bWidth:0,bHeight:0,gWidth:0,gHeight:0,bTop:0,totolSteps:0,startTime:0,bLeft:0,bIndex:0,grids:[],autoSpeed:150,moveSpeed:120,currStatus:"",finalStatus:"",isMoving:false,reSet:function(){this.moveSpeed=120;this.autoSpeed=150;$(".hint-img, .grid").css("background-image",imgSrc);this.updateBorder(1)},init:function(b,a){if(puzzle.isMoving){return}box.empty();this.row=b;this.col=a;let bSize=this.bSize;this.bWidth=box.width();this.bHeight=box.height();hintImg.css("height","100%");util.disableOperate(autoBtn,hintBtn);this.finalStatus=util.getFinalStatus(b,a);let gWidth=this.gWidth=(this.bWidth-(a+1)*bSize)/a;let gHeight=this.gHeight=(this.bHeight-(b+1)*bSize)/b;for(let i=0;i<b*a;i++){let r=Math.floor(i/b),c=i%b;let gTop=gHeight*r+(r+1)*bSize;let gLeft=gWidth*c+(c+1)*bSize;if(i<b*a-1){let grid=$("<div class='grid'></div>");grid.css("top",gTop).css("left",gLeft).css("width",gWidth).css("height",gHeight).css("background-position-x",0-c*gWidth).css("background-position-y",0-r*gHeight).css("background-size",b*100+"% "+a*100+"%").css("background-image",hintImg.css("backgroundImage"));box.append(grid)}else{this.bIndex=i;this.bTop=gTop;this.bLeft=gLeft}}gridsNode=$(".grid")},updateBorder:function(a){if(puzzle.isMoving){return}this.bSize=a;let row=this.row,col=this.col;let gWidth=this.gWidth=(this.bWidth-(col+1)*a)/col;let gHeight=this.gHeight=(this.bHeight-(row+1)*a)/row;this.isMoving=true;for(let i=0;i<row*col-1;i++){let grid=gridsNode.eq(i);let gIndex=grid.attr("index");let bgRow=Math.floor(i/row),bgCol=i%row;let gRow=Math.floor(gIndex/row),gCol=gIndex%row;let bgX=-bgCol*gWidth,bgY=-bgRow*gHeight;let gTop=gHeight*gRow+(gRow+1)*a,gLeft=gWidth*gCol+(gCol+1)*a;grid.css("top",gTop).css("left",gLeft).css("background-position-x",bgX).css("background-position-y",bgY).css("width",gWidth).css("height",gHeight)}let bIndex=this.currStatus.indexOf("\u0000");let bRow=Math.floor(bIndex/row),bCol=bIndex%row;this.bTop=gHeight*bRow+(bRow+1)*a;this.bLeft=gWidth*bCol+(bCol+1)*a;this.isMoving=false},layout:function(){let bSize=this.bSize;let row=this.row,col=this.col;let gWidth=this.gWidth,gHeight=this.gHeight;this.isMoving=true;for(let i=0;i<row*col-1;i++){let ch=String.fromCharCode(97+i);let gIndex=this.currStatus.indexOf(ch);let gRow=Math.floor(gIndex/row),gCol=gIndex%row;let gTop=gHeight*gRow+(gRow+1)*bSize;let gLeft=gWidth*gCol+(gCol+1)*bSize;this.grids[gIndex]=gridsNode.eq(i).attr("index",gIndex).animate({top:gTop,left:gLeft},500,function(){if(i===row*col-2){puzzle.isMoving=false}})}},run:function(){if(puzzle.isMoving){return}let diff=parseInt($(".diff:checked").val());if(this.row!==diff){this.init(diff,diff)}util.advice("");hintImg.css("height",0);stepsBox.text((puzzle.steps=0));$(".minutes-box").empty().append(mCount);$(".seconds-box").empty().append(sCount);mCount.css("animation-play-state","running");sCount.css("animation-play-state","running");this.startTime=new Date().getTime();this.currStatus=util.createStatus(this.finalStatus,this.row,this.col);util.enableOperate(autoBtn,hintBtn);gridsNode.on("mousedown",this.conditionalMove);this.layout()},move:function(a,b){puzzle.isMoving=true;let gIndex=a.attr("index");let desCh=puzzle.currStatus.charAt(gIndex);let bLeft=puzzle.bLeft,bTop=puzzle.bTop;let gTop=a.position().top,gLeft=a.position().left;puzzle.currStatus=puzzle.currStatus.replace("\u0000","*").replace(desCh,"\u0000").replace("*",desCh);a.animate({top:bTop,left:bLeft},puzzle.moveSpeed,function(){puzzle.grids[puzzle.bIndex]=a;a.attr("index",puzzle.bIndex);puzzle.bIndex=gIndex;[puzzle.bTop,puzzle.bLeft]=[gTop,gLeft];if(puzzle.currStatus===puzzle.finalStatus){mCount.css("animation-play-state","paused");sCount.css("animation-play-state","paused");gridsNode.unbind("mousedown");util.disableOperate(autoBtn,hintBtn);let stopTime=Math.floor((new Date().getTime()-puzzle.startTime)/1000);let seconds=stopTime%60;let minutes=Math.floor(stopTime/60);let scanLine=$("<div id='scanLine'></div>");$("#puzzle").prepend(scanLine);scanLine.animate({top:puzzle.bHeight-scanLine.height()+"px"},1500,function(){this.remove()});hintImg.animate({height:puzzle.bHeight+"px"},1500,function(){processBar.css("width","100%");util.advice("拼图完成，耗时"+(minutes?minutes+"分":"")+seconds+"秒");puzzle.isMoving=puzzle.started=false;if(b){util.enableOperate($(".btn, .diff, .border-size, .reset").not("#auto-btn,#hint-btn"))}})}else{puzzle.isMoving=puzzle.started=false}util.update(b)})},conditionalMove:function(){if(puzzle.isMoving){return}let grid=$(this);let bIndex=puzzle.bIndex;let gIndex=grid.attr("index");let col=puzzle.col;let moveAble=Math.abs(bIndex-gIndex)===col;moveAble|=bIndex-gIndex===1&&bIndex%col!==0;moveAble|=gIndex-bIndex===1&&gIndex%col!==0;if(moveAble){puzzle.move(grid,false)}},auto:function(){if(puzzle.isMoving){return}let comps=$(".btn, .diff, .border-size, .reset");util.disableOperate(comps);gridsNode.unbind("mousedown");util.advice("正在搜索......");util.showProcess();$.ajax({url:"auto_complete",type:"POST",timeout:30000,contentType:"application/json",data:JSON.stringify({row:this.row,col:this.col,currStatus:this.currStatus,finalStatus:this.finalStatus}),success:function(a){processBar.stop(true,true);util.advice("完成中......");if(a.length!==0){stepsBox.text((puzzle.steps=puzzle.totolSteps=a.length));let doMove=null,i=0;setTimeout(doMove=function(){if(i===a.length){return}if(!puzzle.isMoving){puzzle.move(puzzle.grids[a[i++]-1],true)}setTimeout(doMove,puzzle.autoSpeed)},0)}else{util.enableOperate(comps);gridsNode.on("mousedown",puzzle.conditionalMove);util.advice("搜索超时，移动几步后再试")}},error:function(){util.enableOperate(comps);gridsNode.on("mousedown",puzzle.conditionalMove);processBar.stop(true,true);util.advice("网络异常！")}})}};puzzle.init(3,3);